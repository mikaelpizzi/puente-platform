version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # INFRASTRUCTURE
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: puente_db
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U user -d puente_db']
      interval: 5s
      timeout: 5s
      retries: 5

  mongo:
    image: mongo:6
    environment:
      MONGO_INITDB_ROOT_USERNAME: user
      MONGO_INITDB_ROOT_PASSWORD: password
    ports:
      - '27017:27017'
    volumes:
      - mongo_data:/data/db

  redis:
    image: redis:7-alpine
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data

  # ---------------------------------------------------------------------------
  # SERVICES
  # ---------------------------------------------------------------------------
  api-gateway:
    build:
      context: .
      dockerfile: apps/backend/api-gateway/Dockerfile
      target: runner
    environment:
      NODE_ENV: production
      API_GATEWAY_PORT: 3000
      AUTH_SERVICE_URL: http://auth-service:3001
      PRODUCTS_SERVICE_URL: http://products-service:3002
      FINANCE_SERVICE_URL: http://finance-service:3003
      LOGISTICS_SERVICE_URL: http://logistics-service:3004
    ports:
      - '3000:3000'
    depends_on:
      - auth-service
      - products-service
      - finance-service
      - logistics-service

  auth-service:
    build:
      context: .
      dockerfile: apps/backend/auth-service/Dockerfile
      target: runner
    environment:
      NODE_ENV: production
      AUTH_SERVICE_PORT: 3001
      AUTH_DATABASE_URL: postgres://user:password@postgres:5432/puente_db?schema=auth
      AUTH_JWT_ACCESS_SECRET: dev-secret
      AUTH_JWT_REFRESH_SECRET: dev-refresh-secret
    ports:
      - '3001:3001'
    depends_on:
      postgres:
        condition: service_healthy

  products-service:
    build:
      context: .
      dockerfile: apps/backend/products-service/Dockerfile
      target: runner
    environment:
      NODE_ENV: production
      PRODUCTS_SERVICE_PORT: 3002
      PRODUCTS_MONGO_URI: mongodb://user:password@mongo:27017/products?authSource=admin
    ports:
      - '3002:3002'
    depends_on:
      - mongo

  finance-service:
    build:
      context: .
      dockerfile: apps/backend/finance-service/Dockerfile
      target: runner
    environment:
      NODE_ENV: production
      FINANCE_SERVICE_PORT: 3003
      FINANCE_DATABASE_URL: postgres://user:password@postgres:5432/puente_db?schema=finance
    ports:
      - '3003:3003'
    depends_on:
      postgres:
        condition: service_healthy

  logistics-service:
    build:
      context: .
      dockerfile: apps/backend/logistics-service/Dockerfile
      target: runner
    environment:
      NODE_ENV: production
      LOGISTICS_SERVICE_PORT: 3004
      LOGISTICS_VALKEY_URL: redis://redis:6379
    ports:
      - '3004:3004'
    depends_on:
      - redis

  frontend:
    build:
      context: .
      dockerfile: apps/frontend/pwa/Dockerfile
    ports:
      - '8080:80'
    depends_on:
      - api-gateway

volumes:
  postgres_data:
  mongo_data:
  redis_data:
